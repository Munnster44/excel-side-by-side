<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Excel Side-by-Side Viewer v3.3.3-r3 (Full GitHub Edition)</title>
<meta name="theme-color" content="#003366" />
<link rel="manifest" href="manifest.json">
<link rel="icon" sizes="192x192" href="icon-192.png">
<link rel="icon" sizes="512x512" href="icon-512.png">
<style>
  :root{--brand:#003366;--bg:#f6f8fb;--panel:#fff;--muted:#667;--border:#e2e8f0;--btn:#1f6feb}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
  header{background:var(--brand);color:#fff;padding:18px 14px;text-align:center;font-weight:700;font-size:1.4rem}
  main{max-width:1260px;margin:20px auto;padding:0 14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
  label{font-weight:600;margin-right:6px}
  input[type=file]{padding:6px;border:1px dashed var(--border);border-radius:10px;background:#fff}
  select{padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff}
  .btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--btn);border-color:var(--btn);color:#fff}
  .btn.ghost{background:transparent}
  .btn.badge{border-radius:10px}
  .counts{font-weight:700}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .pane{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
  .pane header{background:#f3f6fb;color:var(--muted);padding:10px 12px;font-weight:600}
  .scroll{height:68vh;overflow:auto;padding:12px}
  table{border-collapse:collapse;font-size:14px;width:100%}
  th,td{border:1px solid #ddd;padding:6px 8px;white-space:pre-wrap;vertical-align:top}
  .match-ok{background:#e8f8ec}
  .match-bad{background:#fff3cd}
  .highlight{outline:2px solid gold}
  .footer{color:#667;text-align:center;margin:24px 0 34px;font-size:.9rem}
  dialog{border:none;border-radius:16px;max-width:900px;width:min(92vw,900px);padding:0}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .modal-head{background:var(--brand);color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
  .modal-body{background:#fff;max-height:70vh;overflow:auto;padding:14px;white-space:pre-wrap}
</style>
</head>
<body>
<header>Excel Side-by-Side Viewer v3.3.3-r3 (Full GitHub Edition)</header>

<main>
  <section class="card">
    <div class="row">
      <div><label for="fileA">File A</label><input type="file" id="fileA" accept=".xlsx"></div>
      <div><label for="fileB">File B</label><input type="file" id="fileB" accept=".xlsx"></div>
      <div><label for="colSelect">Compare Column</label>
        <select id="colSelect" disabled><option>Waiting for files…</option></select>
      </div>
    </div>

    <div class="row">
      <button class="btn primary" id="btnCompare">Compare</button>
      <button class="btn" id="btnOnlyNonMatches">Show Only Non-Matches</button>

      <button class="btn badge" id="btnAll">All</button>
      <button class="btn badge" id="btnMatches">Matches</button>
      <button class="btn badge" id="btnUnmatched">Unmatched</button>

      <button class="btn" id="btnSync">Sync Scroll: OFF</button>
      <button class="btn" id="btnHelp" title="About this app">?</button>
      <button class="btn" id="btnDownload">Download Report</button>
    </div>

    <div class="row">
      <input id="searchBox" type="text" placeholder="Search across all columns…" style="flex:1;min-width:260px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff">
      <button class="btn" id="btnFindNext">Find Next</button>
      <button class="btn" id="btnClear">Clear Search</button>
      <button class="btn" id="btnReset">Reset View</button>
      <span class="counts" id="counts">File A: 0 / 0 rows | File B: 0 / 0 rows</span>
    </div>
  </section>

  <div class="row" style="margin:8px 2px; font-weight:800;">
    <span id="stats">File A: 0 rows | File B: 0 rows | Matches: 0 | Unmatched: 0</span>
  </div>

  <section class="grid">
    <div class="pane">
      <header>File A</header>
      <div class="scroll" id="paneA"><em>Waiting for files…</em></div>
    </div>
    <div class="pane">
      <header>File B</header>
      <div class="scroll" id="paneB"><em>Waiting for files…</em></div>
    </div>
  </section>

  <div class="footer">© 2025 Glen Carruthers — Excel Side-by-Side Viewer v3.3.3-r3 (Full GitHub Edition, PWA)</div>
</main>

<!-- README modal -->
<dialog id="readmeModal">
  <div class="modal-head">
    <strong>README — Excel Side-by-Side Viewer (v3.3.3-r3)</strong>
    <button class="btn" id="closeReadme">Close</button>
  </div>
  <div class="modal-body" id="readmeBody"></div>
</dialog>

<script src="xlsx.full.min.js"></script>
<script>
/* ===== Core State ===== */
let wbA=null, wbB=null, wsA=null, wsB=null;
let dataA=[], dataB=[], headers=[];
let syncOn=false;
let lastFilter="all";
let searchHits=[], searchIndex=-1;

/* ===== Utilities ===== */
const $ = sel => document.querySelector(sel);
const byId = id => document.getElementById(id);
const pad = n => String(n).padStart(2,"0");
const timestamp = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}` };

function aoa(ws){
  const ref = ws["!ref"] || "A1:A1";
  const r = XLSX.utils.decode_range(ref);
  const out=[];
  for(let i=r.s.r;i<=r.e.r;i++){
    const row=[];
    for(let j=r.s.c;j<=r.e.c;j++){
      const addr = XLSX.utils.encode_cell({r:i,c:j});
      const cell = ws[addr];
      row.push(cell ? String(cell.v) : "");
    }
    out.push(row);
  }
  return out;
}

function buildTable(rows, clsMap){
  // clsMap: Map(rowIndex -> "match-ok"/"match-bad")
  if(!rows.length) return "<em>No data</em>";
  const thead = rows[0].map(h=>`<th>${escapeHtml(h)}</th>`).join("");
  let trs = "";
  for(let i=1;i<rows.length;i++){
    const row = rows[i] || [];
    const cls = clsMap?.get(i) || "";
    trs += `<tr class="${cls}">` + row.map(v=>`<td>${escapeHtml(v)}</td>`).join("") + `</tr>`;
  }
  return `<table><thead><tr>${thead}</tr></thead><tbody>${trs}</tbody></table>`;
}

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m])) }

function populateColumnSelect(){
  headers = dataA[0] && dataB[0] ? dataA[0] : (dataA[0]||dataB[0]||[]);
  const sel = byId("colSelect");
  sel.innerHTML = headers.map((h,i)=>`<option value="${i}">${escapeHtml(h||("Column "+XLSX.utils.encode_col(i)))}</option>`).join("");
  sel.disabled = false;
}

/* ===== Comparison ===== */
function compareByColumn(colIndex){
  // Build lookup from B on selected column
  const key = (v) => String(v).trim().toLowerCase();
  const mapB = new Map();
  for(let i=1;i<dataB.length;i++){
    const v = dataB[i]?.[colIndex] ?? "";
    mapB.set(key(v), i);
  }
  let matches=0, unmatches=0;
  const clsA = new Map(), clsB = new Map();
  for(let i=1;i<dataA.length;i++){
    const vA = dataA[i]?.[colIndex] ?? "";
    if(vA==="" && dataA[i].every(x=>x==="")) continue;
    const idxB = mapB.get(key(vA));
    if(idxB!=null){ matches++; clsA.set(i,"match-ok"); clsB.set(idxB,"match-ok"); }
    else{ unmatches++; clsA.set(i,"match-bad"); }
  }
  // Mark B rows that never matched A
  for(let i=1;i<dataB.length;i++){
    if(!clsB.has(i) && !(dataB[i].every(x=>x===""))) { clsB.set(i,"match-bad"); unmatches++; }
  }
  updateStats(matches, unmatches);
  renderTables(clsA, clsB);
}

function updateStats(matches, unmatches){
  const aRows = Math.max(0, (dataA.length-1));
  const bRows = Math.max(0, (dataB.length-1));
  $("#counts").textContent = `File A: 0 / ${aRows} rows | File B: 0 / ${bRows} rows`;
  $("#stats").textContent  = `File A: ${aRows} rows | File B: ${bRows} rows | Matches: ${matches||0} | Unmatched: ${unmatches||0}`;
}

/* ===== Rendering & Filters ===== */
function renderTables(clsA=new Map(), clsB=new Map()){
  const htmlA = buildTable(dataA, clsA);
  const htmlB = buildTable(dataB, clsB);
  $("#paneA").innerHTML = htmlA;
  $("#paneB").innerHTML = htmlB;
  applyFilter(lastFilter);
  wireScrollSync(); // ensure handler exists on current DOM
}

function applyFilter(mode){
  lastFilter = mode;
  const keep = (row) => {
    if(mode==="all") return true;
    const isBad = row.classList.contains("match-bad");
    const isOk  = row.classList.contains("match-ok");
    if(mode==="matches") return isOk;
    if(mode==="unmatched") return isBad;
    if(mode==="only-non-matches") return isBad; // alias
    return true;
  };
  [$("#paneA"), $("#paneB")].forEach(p=>{
    p.querySelectorAll("tbody tr").forEach(tr=> tr.style.display = keep(tr) ? "" : "none");
  });
}

/* ===== Scroll Sync ===== */
function wireScrollSync(){
  const a=$("#paneA"), b=$("#paneB");
  if(!a || !b) return;
  let block=false;
  function sync(from, to){
    if(!syncOn || block) return;
    block=true;
    const ratio = from.scrollTop / ((from.scrollHeight - from.clientHeight) || 1);
    to.scrollTop = ratio * (to.scrollHeight - to.clientHeight);
    setTimeout(()=>block=false, 0);
  }
  a.onscroll = () => sync(a,b);
  b.onscroll = () => sync(b,a);
}

/* ===== Search ===== */
function clearSearch(){
  searchHits.forEach(el=>el.classList.remove("highlight"));
  searchHits=[]; searchIndex=-1;
}
function doSearch(q){
  clearSearch();
  if(!q) return;
  [$("#paneA"),$("#paneB")].forEach(p=>{
    p.querySelectorAll("td,th").forEach(td=>{
      if(td.textContent.toLowerCase().includes(q.toLowerCase())){
        td.classList.add("highlight");
        searchHits.push(td);
      }
    });
  });
}
function findNext(){
  if(!searchHits.length) return;
  searchIndex = (searchIndex+1) % searchHits.length;
  searchHits[searchIndex].scrollIntoView({block:"center",behavior:"smooth"});
}

/* ===== Download Report (.xlsx) ===== */
function buildDiffSheet(){
  const rowsA = dataA;
  const rowsB = dataB;
  const maxR = Math.max(rowsA.length, rowsB.length);
  const maxC = Math.max(
    ...[rowsA,rowsB].map(rows => rows.reduce((m,r)=>Math.max(m, r?.length||0),0))
  );
  const out = [["Row","Col","A","B","Match"]];
  for(let r=1;r<maxR;r++){
    for(let c=0;c<maxC;c++){
      const a = (rowsA[r] && rowsA[r][c]) ?? "";
      const b = (rowsB[r] && rowsB[r][c]) ?? "";
      if(a !== b) out.push([r, XLSX.utils.encode_col(c), a, b, "≠"]);
    }
  }
  if(out.length===1) out.push(["No differences detected"]);
  return out;
}
function downloadReport(){
  if(!wsA || !wsB){ alert("Load and compare first."); return; }
  const wbOut = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wbOut, XLSX.utils.aoa_to_sheet(dataA), "A");
  XLSX.utils.book_append_sheet(wbOut, XLSX.utils.aoa_to_sheet(dataB), "B");
  XLSX.utils.book_append_sheet(wbOut, XLSX.utils.aoa_to_sheet(buildDiffSheet()), "DIFF");
  XLSX.writeFile(wbOut, `compare_results_${timestamp()}.xlsx`);
}

/* ===== README ===== */
function getReadme(){
return [
"Excel Side-by-Side Viewer — v3.3.3-r3 (Full GitHub Edition, PWA)",
"----------------------------------------------------------------",
"Features:",
"- Load two .xlsx files, pick a Compare Column, and analyze Matches vs Unmatched.",
"- Filters: All / Matches / Unmatched and “Show Only Non-Matches”.",
"- Synchronized scrolling (ON/OFF).",
"- Search across both panes (Find Next / Clear).",
"- Download Report exports A, B, and DIFF sheets to an .xlsx with a timestamp.",
"",
"Notes:",
"- Only the first worksheet from each file is analyzed and displayed.",
"- Compare Column options come from File A’s headers (must also exist in File B).",
"- This edition is split for GitHub Pages and includes a PWA manifest + service worker.",
""
].join("\\n");
}

/* ===== Event Wiring ===== */
async function loadWorkbook(file){ 
  const buf = await file.arrayBuffer();
  return XLSX.read(new Uint8Array(buf), {type:"array"});
}

async function handleCompare(){
  const fa = byId("fileA").files[0];
  const fb = byId("fileB").files[0];
  if(!fa || !fb){ alert("Please choose File A and File B (.xlsx)."); return; }

  wbA = await loadWorkbook(fa);
  wbB = await loadWorkbook(fb);
  wsA = wbA.Sheets[wbA.SheetNames[0]];
  wsB = wbB.Sheets[wbB.SheetNames[0]];
  dataA = aoa(wsA);
  dataB = aoa(wsB);

  populateColumnSelect();
  const colIdx = parseInt(byId("colSelect").value || 0, 10) || 0;
  compareByColumn(colIdx);
}

document.addEventListener("DOMContentLoaded", () => {
  // initial UI state
  $("#btnAll").classList.add("primary");

  $("#btnCompare").addEventListener("click", handleCompare);
  $("#colSelect").addEventListener("change", () => {
    if(!dataA.length || !dataB.length) return;
    compareByColumn(parseInt(byId("colSelect").value,10)||0);
  });

  $("#btnOnlyNonMatches").addEventListener("click", () => applyFilter("only-non-matches"));
  $("#btnAll").addEventListener("click", () => { $(".primary")?.classList.remove("primary"); $("#btnAll").classList.add("primary"); applyFilter("all"); });
  $("#btnMatches").addEventListener("click", () => { $(".primary")?.classList.remove("primary"); $("#btnMatches").classList.add("primary"); applyFilter("matches"); });
  $("#btnUnmatched").addEventListener("click", () => { $(".primary")?.classList.remove("primary"); $("#btnUnmatched").classList.add("primary"); applyFilter("unmatched"); });

  $("#btnSync").addEventListener("click", () => {
    syncOn = !syncOn;
    $("#btnSync").textContent = `Sync Scroll: ${syncOn? "ON":"OFF"}`;
  });

  $("#btnDownload").addEventListener("click", downloadReport);

  $("#btnFindNext").addEventListener("click", () => {
    const q = $("#searchBox").value.trim();
    if(!q) return;
    if(!searchHits.length) doSearch(q);
    findNext();
  });
  $("#btnClear").addEventListener("click", () => { $("#searchBox").value=""; clearSearch(); });
  $("#searchBox").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ clearSearch(); doSearch(e.target.value.trim()); findNext(); } });

  $("#btnReset").addEventListener("click", () => location.reload());

  // README
  const modal = byId("readmeModal");
  $("#btnHelp").addEventListener("click", () => { byId("readmeBody").textContent = getReadme(); modal.showModal(); });
  $("#closeReadme").addEventListener("click", () => modal.close());

  // PWA registration
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./service-worker.js").catch(console.error);
  }
});
</script>
</body>
</html>
