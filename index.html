<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Excel Side-by-Side Viewer v3.3.3-r3</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f9fb;color:#222;text-align:center}
header{background:#003366;color:#fff;padding:15px;font-size:1.5em;font-weight:bold}
main{padding:20px}
button{margin:6px;padding:10px 15px;border:1px solid #ccc;border-radius:6px;cursor:pointer;font-weight:bold;background:#fff}
button:hover{background:#e7eefb}
input[type=file]{margin:10px}
.search{margin:10px 0}
iframe{width:48%;height:70vh;border:1px solid #ccc}
#resultArea{display:flex;justify-content:space-around;flex-wrap:wrap;margin-top:15px}
footer{margin-top:30px;color:#666;font-size:0.9em}
.highlight{background:yellow}
dialog{border:none;border-radius:10px;max-width:800px;width:90vw}
dialog::backdrop{background:rgba(0,0,0,0.4)}
</style>
</head>
<body>
<header>Excel Side-by-Side Viewer v3.3.3-r3</header>

<main>
  <p>Select two Excel files to compare:</p>
  <input type="file" id="file1" accept=".xlsx">
  <input type="file" id="file2" accept=".xlsx">
  <div>
    <button id="btnLoad">Load & Compare</button>
    <button id="btnLock">Lock Scroll</button>
    <button id="btnUnlock" style="display:none">Unlock Scroll</button>
    <button id="btnReset">Reset</button>
  </div>

  <div class="search">
    <input type="text" id="searchInput" placeholder="Search in both files">
    <button id="btnFindNext">Find Next</button>
    <button id="btnClearSearch">Clear</button>
  </div>

  <div>
    <button id="btnReadme">README</button>
    <button id="btnDownloadReadme">Download README</button>
    <button id="btnSave">Save Comparison (.xlsx)</button>
  </div>

  <div id="resultArea">
    <iframe id="frame1"></iframe>
    <iframe id="frame2"></iframe>
  </div>
</main>

<footer>v3.3.3-r3 © 2025 Glen Carruthers — Excel Side-by-Side Viewer</footer>

<dialog id="readmeModal">
  <h3>README — Excel Side-by-Side Viewer v3.3.3-r3</h3>
  <pre id="readmeBody" style="text-align:left;white-space:pre-wrap"></pre>
  <button id="closeReadme">Close</button>
</dialog>

<script src="xlsx.full.min.js"></script>
<script>
// ==============================
// Excel Side-by-Side Viewer v3.3.3-r3
// ==============================

let wbA=null, wbB=null, htmlA="", htmlB="";
let syncEnabled=false;
let searchHits=[], searchIndex=-1;

// helper
const byId=id=>document.getElementById(id);

// read file -> workbook
function readExcelFile(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=e=>{
      try{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:"array"});
        resolve(wb);
      }catch(err){reject(err);}
    };
    fr.onerror=reject;
    fr.readAsArrayBuffer(file);
  });
}

// workbook to html
function sheetToHTML(wb){
  const name=wb.SheetNames[0];
  const ws=wb.Sheets[name];
  return XLSX.utils.sheet_to_html(ws,{editable:false});
}

function render(){
  byId("frame1").srcdoc=htmlA||"<em>No data</em>";
  byId("frame2").srcdoc=htmlB||"<em>No data</em>";
}

// scroll sync
function addScrollSync(){
  const a=byId("frame1").contentWindow,b=byId("frame2").contentWindow;
  if(!a||!b)return;
  function sync(from,to){
    if(!syncEnabled)return;
    const ratio=from.scrollY/(from.document.body.scrollHeight-from.innerHeight||1);
    to.scrollTo(0,ratio*(to.document.body.scrollHeight-to.innerHeight));
  }
  a.addEventListener("scroll",()=>sync(a,b));
  b.addEventListener("scroll",()=>sync(b,a));
}

// search
function clearSearch(){
  searchHits.forEach(el=>el.style.background="");
  searchHits=[];searchIndex=-1;
}
function search(q){
  clearSearch();
  if(!q)return;
  const frames=[byId("frame1").contentDocument,byId("frame2").contentDocument];
  frames.forEach(doc=>{
    if(!doc)return;
    doc.querySelectorAll("td,th").forEach(td=>{
      if(td.textContent.toLowerCase().includes(q.toLowerCase())){
        td.style.background="yellow";
        searchHits.push(td);
      }
    });
  });
}
function nextHit(){
  if(!searchHits.length)return;
  searchIndex=(searchIndex+1)%searchHits.length;
  searchHits[searchIndex].scrollIntoView({block:"center"});
}

// save diff
function wsTo2D(ws){
  const r=XLSX.utils.decode_range(ws["!ref"]||"A1:A1");
  const rows=[];
  for(let i=r.s.r;i<=r.e.r;i++){
    const row=[];
    for(let j=r.s.c;j<=r.e.c;j++){
      const addr=XLSX.utils.encode_cell({r:i,c:j});
      const cell=ws[addr];
      row.push(cell?String(cell.v):"");
    }
    rows.push(row);
  }
  return rows;
}
function buildDiff(rowsA,rowsB){
  const maxR=Math.max(rowsA.length,rowsB.length);
  const maxC=Math.max(
    ...[rowsA,rowsB].map(r=>r.reduce((m,a)=>Math.max(m,a.length),0))
  );
  const diff=[["Row","Col","A","B","Match"]];
  for(let r=0;r<maxR;r++){
    for(let c=0;c<maxC;c++){
      const a=(rowsA[r]&&rowsA[r][c])||"",b=(rowsB[r]&&rowsB[r][c])||"";
      if(a!==b)diff.push([r+1,XLSX.utils.encode_col(c),a,b,"≠"]);
    }
  }
  if(diff.length===1)diff.push(["No differences found"]);
  return diff;
}
function timestamp(){
  const d=new Date(),p=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}_${p(d.getHours())}-${p(d.getMinutes())}-${p(d.getSeconds())}`;
}
function saveDiff(){
  if(!wbA||!wbB){alert("Load both files first");return;}
  const wsA=wbA.Sheets[wbA.SheetNames[0]],wsB=wbB.Sheets[wbB.SheetNames[0]];
  const rowsA=wsTo2D(wsA),rowsB=wsTo2D(wsB);
  const wbOut=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wbOut,wsA,"A");
  XLSX.utils.book_append_sheet(wbOut,wsB,"B");
  const diff=XLSX.utils.aoa_to_sheet(buildDiff(rowsA,rowsB));
  XLSX.utils.book_append_sheet(wbOut,diff,"DIFF");
  XLSX.writeFile(wbOut,`compare_results_${timestamp()}.xlsx`);
}

// readme
function getReadme(){
return `Excel Side-by-Side Viewer v3.3.3-r3
----------------------------------------
Usage:
1. Select two Excel files (.xlsx) and click "Load & Compare".
2. Use Lock/Unlock Scroll to sync viewing.
3. Use Search / Find Next to locate data in both panes.
4. Click "Save Comparison" to export both sheets and a DIFF sheet.
5. Click "Reset" to clear the session.

Notes:
- Only the first worksheet of each file is displayed.
- DIFF sheet lists mismatched cells (A vs B) with coordinates.
- Files saved with timestamp to prevent overwrites.
- Offline or GitHub Pages compatible.

© 2025 Glen Carruthers
`;
}

// setup
document.addEventListener("DOMContentLoaded",()=>{
  byId("btnLoad").onclick=async()=>{
    const f1=byId("file1").files[0],f2=byId("file2").files[0];
    if(!f1||!f2){alert("Select both files");return;}
    try{
      [wbA,wbB]=await Promise.all([readExcelFile(f1),readExcelFile(f2)]);
      htmlA=sheetToHTML(wbA);
      htmlB=sheetToHTML(wbB);
      render();
      setTimeout(addScrollSync,500);
    }catch(e){alert("Error loading files");console.error(e);}
  };

  byId("btnLock").onclick=()=>{syncEnabled=true;byId("btnLock").style.display="none";byId("btnUnlock").style.display="";}
  byId("btnUnlock").onclick=()=>{syncEnabled=false;byId("btnUnlock").style.display="none";byId("btnLock").style.display="";}

  byId("btnFindNext").onclick=()=>{const q=byId("searchInput").value.trim();if(q&&!searchHits.length)search(q);nextHit();}
  byId("btnClearSearch").onclick=()=>{byId("searchInput").value="";clearSearch();}
  byId("searchInput").addEventListener("keydown",e=>{if(e.key==="Enter"){clearSearch();search(e.target.value.trim());nextHit();}});

  byId("btnSave").onclick=saveDiff;
  byId("btnReset").onclick=()=>location.reload();

  // README
  const modal=byId("readmeModal");
  byId("btnReadme").onclick=()=>{byId("readmeBody").textContent=getReadme();modal.showModal();}
  byId("closeReadme").onclick=()=>modal.close();
  byId("btnDownloadReadme").onclick=()=>{
    const blob=new Blob([getReadme()],{type:"text/plain"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);
    a.download="README.txt";a.click();URL.revokeObjectURL(a.href);
  };
});
</script>
</body>
</html>
