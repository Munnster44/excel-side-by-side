<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Excel Side-by-Side Viewer v3.3.3-r3 (PWA-Lite)</title>
<meta name="theme-color" content="#003366" />
<link rel="manifest" href="manifest.json">
<link rel="icon" sizes="192x192" href="icon-192.png">
<link rel="icon" sizes="512x512" href="icon-512.png">
<style>
:root{--brand:#003366;--bg:#f6f8fb;--panel:#fff;--muted:#667;--border:#e2e8f0;--btn:#1f6feb}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
header{background:var(--brand);color:#fff;padding:18px 14px;text-align:center;font-weight:700;font-size:1.4rem}
main{max-width:1260px;margin:20px auto;padding:0 14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
label{font-weight:600;margin-right:6px}
input[type=file]{padding:6px;border:1px dashed var(--border);border-radius:10px;background:#fff}
select{padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff}
.btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--btn);border-color:var(--btn);color:#fff}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.pane{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
.pane header{background:#f3f6fb;color:var(--muted);padding:10px 12px;font-weight:600}
.scroll{height:68vh;overflow:auto;padding:12px}
table{border-collapse:collapse;font-size:14px;width:100%}
th,td{border:1px solid #ddd;padding:6px 8px;white-space:pre-wrap;vertical-align:top}
.match-ok{background:#e8f8ec}
.match-bad{background:#fff3cd}
.footer{color:#667;text-align:center;margin:24px 0 34px;font-size:.9rem}

/* Spinner overlay */
#spinner {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(255,255,255,0.7);
  z-index:9999;
  align-items:center;
  justify-content:center;
}
.spinner-circle {
  border:6px solid #f3f3f3;
  border-top:6px solid var(--brand);
  border-radius:50%;
  width:60px; height:60px;
  animation:spin 1s linear infinite;
}
@keyframes spin {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}
</style>
</head>
<body>
<header>Excel Side-by-Side Viewer v3.3.3-r3 (PWA-Lite)</header>

<!-- Spinner overlay -->
<div id="spinner"><div class="spinner-circle"></div></div>

<main>
<section class="card">
 <div class="row">
   <div><label for="fileA">File A</label><input type="file" id="fileA" accept=".xlsx"></div>
   <div><label for="fileB">File B</label><input type="file" id="fileB" accept=".xlsx"></div>
   <div><label for="colSelect">Compare Column</label>
     <select id="colSelect" disabled><option>Waiting for files…</option></select>
   </div>
 </div>

 <div class="row">
   <button class="btn primary" id="btnCompare">Compare</button>
   <button class="btn" id="btnOnlyNonMatches">Show Only Non-Matches</button>
   <button class="btn" id="btnAll">All</button>
   <button class="btn" id="btnMatches">Matches</button>
   <button class="btn" id="btnUnmatched">Unmatched</button>
   <button class="btn" id="btnSync">Sync Scroll: ON</button>
   <button class="btn" id="btnDownload">Download Report</button>
 </div>

 <div class="row">
   <input id="searchBox" type="text" placeholder="Search (rows filtered live)…"
     style="flex:1;min-width:260px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff">
   <button class="btn" id="btnClear">Clear</button>
   <button class="btn" id="btnReset">Reset View</button>
 </div>

 <div class="row" style="margin-top:6px;">
   <div id="stats" style="font-weight:700;line-height:1.5em;">Waiting for files…</div>
 </div>
</section>

<section class="grid">
 <div class="pane"><header>File A</header><div class="scroll" id="paneA"><em>Waiting for files…</em></div></div>
 <div class="pane"><header>File B</header><div class="scroll" id="paneB"><em>Waiting for files…</em></div></div>
</section>

<div class="footer">© 2025 Glen Carruthers — Excel Side-by-Side Viewer v3.3.3-r3 (PWA-Lite)</div>
</main>

<script src="xlsx.full.min.js"></script>
<script>
let wbA,wbB,wsA,wsB,dataA=[],dataB=[],headers=[];
let syncOn=true,lastFilter="all";
const $=s=>document.querySelector(s),byId=i=>document.getElementById(i);
const pad=n=>String(n).padStart(2,"0");
const timestamp=()=>{const d=new Date();return`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}-${pad(d.getSeconds())}`};
function aoa(ws){const r=XLSX.utils.decode_range(ws["!ref"]);const o=[];for(let i=r.s.r;i<=r.e.r;i++){const row=[];for(let j=r.s.c;j<=r.e.c;j++){const a=XLSX.utils.encode_cell({r:i,c:j});const c=ws[a];row.push(c?String(c.v):"");}o.push(row);}return o;}
function escapeHtml(s){return String(s).replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]))}
function buildTable(rows,map){if(!rows.length)return"<em>No data</em>";const th=rows[0].map(h=>`<th>${escapeHtml(h)}</th>`).join("");let tr="";for(let i=1;i<rows.length;i++){const cls=map?.get(i)||"";tr+=`<tr class="${cls}">`+rows[i].map(v=>`<td>${escapeHtml(v)}</td>`).join("")+"</tr>";}return`<table><thead><tr>${th}</tr></thead><tbody>${tr}</tbody></table>`}
function renderTables(cA=new Map(),cB=new Map()){byId("paneA").innerHTML=buildTable(dataA,cA);byId("paneB").innerHTML=buildTable(dataB,cB);applyFilter(lastFilter);wireScroll();}
function populateColumns(){headers=dataA[0]||dataB[0]||[];const sel=byId("colSelect");sel.innerHTML=headers.map((h,i)=>`<option value="${i}">${escapeHtml(h||("Col "+XLSX.utils.encode_col(i)))}</option>`).join("");sel.disabled=false;}
function compare(col){const key=v=>String(v).trim().toLowerCase();const mapB=new Map();for(let i=1;i<dataB.length;i++){mapB.set(key(dataB[i]?.[col]??""),i);}let m=0,u=0;const cA=new Map(),cB=new Map();for(let i=1;i<dataA.length;i++){const v=dataA[i]?.[col]??"";const idx=mapB.get(key(v));if(idx!=null){m++;cA.set(i,"match-ok");cB.set(idx,"match-ok");}else{u++;cA.set(i,"match-bad");}}for(let i=1;i<dataB.length;i++)if(!cB.has(i))cB.set(i,"match-bad");renderTables(cA,cB);
  $("#stats").innerHTML=`File A: ${dataA.length-1}<br>File B: ${dataB.length-1}<br>Matches: ${m}<br>Unmatched: ${u}`;}
function autoCompare(){const idx=headers.findIndex(h=>h.trim().toLowerCase()==="user id");compare(idx>=0?idx:0);}
function applyFilter(mode){lastFilter=mode;[$("#paneA"),$("#paneB")].forEach(p=>{p.querySelectorAll("tbody tr").forEach(tr=>{const ok=tr.classList.contains("match-ok"),bad=tr.classList.contains("match-bad");tr.style.display=(mode==="all")?"":(mode==="matches"?ok?"":"none":bad?"":"none");});});}
function filterSearch(q){q=q.toLowerCase();[$("#paneA"),$("#paneB")].forEach(p=>{p.querySelectorAll("tbody tr").forEach(tr=>{tr.style.display=tr.textContent.toLowerCase().includes(q)?"":"none";});});}
function wireScroll(){const a=$("#paneA"),b=$("#paneB");if(!a||!b)return;let lock=false;function sync(f,t){if(!syncOn||lock)return;lock=true;const r=f.scrollTop/((f.scrollHeight-f.clientHeight)||1);t.scrollTop=r*(t.scrollHeight-t.clientHeight);setTimeout(()=>lock=false,0);}a.onscroll=()=>sync(a,b);b.onscroll=()=>sync(b,a);}
async function load(file){const buf=await file.arrayBuffer();return XLSX.read(new Uint8Array(buf),{type:"array"});}
async function handleLoad(){
  const fA=byId("fileA").files[0],fB=byId("fileB").files[0];
  if(!fA||!fB)return;
  const spinner=byId("spinner");
  spinner.style.display="flex";
  try{
    wbA=await load(fA);
    wbB=await load(fB);
    wsA=wbA.Sheets[wbA.SheetNames[0]];
    wsB=wbB.Sheets[wbB.SheetNames[0]];
    dataA=aoa(wsA);
    dataB=aoa(wsB);
    populateColumns();
    autoCompare();
  }finally{
    spinner.style.display="none";
  }
}
function saveReport(){if(!dataA.length||!dataB.length){alert("Load both files first.");return;}const colIdx=headers.findIndex(h=>h.trim().toLowerCase()==="user id");const col=(colIdx>=0?colIdx:0);const key=v=>String(v).trim().toLowerCase();const mapB=new Map();for(let i=1;i<dataB.length;i++){mapB.set(key(dataB[i]?.[col]??""),i);}const aM=[dataA[0]],bM=[dataB[0]],aU=[dataA[0]],bU=[dataB[0]];const used=new Set();for(let i=1;i<dataA.length;i++){const v=dataA[i]?.[col]??"";const idx=mapB.get(key(v));if(idx!=null){aM.push(dataA[i]);bM.push(dataB[idx]);used.add(idx);}else aU.push(dataA[i]);}for(let i=1;i<dataB.length;i++)if(!used.has(i))bU.push(dataB[i]);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(aM),"A-MATCHED");XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(bM),"B-MATCHED");XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(aU),"A-UNMATCHED");XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(bU),"B-UNMATCHED");XLSX.writeFile(wb,`compare_${timestamp()}.xlsx`);}
document.addEventListener("DOMContentLoaded",()=>{
  byId("fileA").onchange=byId("fileB").onchange=handleLoad;
  $("#btnCompare").onclick=()=>compare(parseInt(byId("colSelect").value)||0);
  $("#btnOnlyNonMatches").onclick=()=>applyFilter("unmatched");
  $("#btnAll").onclick=()=>applyFilter("all");
  $("#btnMatches").onclick=()=>applyFilter("matches");
  $("#btnUnmatched").onclick=()=>applyFilter("unmatched");
  $("#btnSync").onclick=()=>{syncOn=!syncOn;$("#btnSync").textContent=`Sync Scroll: ${syncOn?"ON":"OFF"}`};
  $("#btnDownload").onclick=saveReport;
  $("#btnReset").onclick=()=>location.reload();
  $("#searchBox").addEventListener("input",e=>filterSearch(e.target.value));
  $("#btnClear").onclick=()=>{$("#searchBox").value="";filterSearch("");};
});
</script>
</body>
</html>
